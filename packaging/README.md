# Releasing pg-backup-api

## Update the release notes

Add a new entry to the top of the [news.yml](../pg_backup_api/news.yml) file containing any `Notable changes`, `Minor changes` and `Bugfixes` for this release.

Make sure you include your name and email in the `author` field as this will be included in the rpm and deb changelogs.

Set the `version` field of the release notes to the new pg-backup-api version.
Use [semantic versioning](https://semver.org/) when determining the new version.

If you are publishing new packages for an existing version of pg-backup-api then include the `iteration` field and set this to `RELEASE_VERSION + 1` where `RELEASE VERSION` is the value specified in the [Publish to Cloudsmith workflow](../.github/workflows/publish-to-cloudsmith.yml).

## Prepare the release

From the `packaging` directory, run `scripts/release.sh` (you will need the following python dependencies: dateutil, jinja2, pyyaml). This script will:

1. Read the version and package revision from news.yml.
2. Set the new value of `RELEASE_VERSION` in the [Publish to Cloudsmith workflow](../.github/workflows/publish-to-cloudsmith.yml).
3. Set the new version in [version.txt](../pg_backup_api/version.txt).
4. Update [news.md](../pg_backup_api/news.md) and the changelogs for the [rpm](changelogs/rpm.changelog) and [deb](changelogs/deb.changelog) packages.
5. Commit the modified files in a commit named `Prepare release VERSION` where `VERSION` is the version suffixed by the package revision.

## Publish the release

After reviewing the commit generated by the release script, push a branch to the pg-backup-api repository and make a PR.

Tag the release with the tag provided in the output of the release script and push the tag.

Run the [Publish to Cloudsmith](https://github.com/EnterpriseDB/pg-backup-api/actions/workflows/publish-to-cloudsmith.yml) workflow being sure to set the `Is release` option to `Y`.

You can download the published packages using the [Cloudsmith CLI](https://github.com/cloudsmith-io/cloudsmith-cli) or with the [cs-dl.sh](scripts/cs-dl.sh) wrapper script, e.g.: `scripts/cs-dl.sh ibm-dev 0.1.0-1`.

Once happy with the packages in staging they need to be copied to the production repositories.

### Cloudsmith prod repo

Using the Cloudsmith cli, copy the packages from the `ibm-dev` staging repo to the `edb` repo.
The [cs-cp.sh](scripts/cs-cp.sh) wrapper script can be used to simplify this step, e.g: `scripts/cs-cp.sh 0.1.0-1`.

Also using the Cloudsmith cli, add the `production` tag to packages you just copied in the `edb` repo.
The [cs-tag.sh](scripts/cs-tag.sh) wrapper script can be used to simplify this step, e.g.: `scripts/cs-tag.sh 0.1.0-1 production`.

### EDB repos `{apt,yum,zypp}.enterprisedb.com`

Once packages are tagged with `production` in the `edb` Cloudsmith repository they will automatically be synced to the EDB repositories.

### 2ndQuadrant repos

Use the following (non-public) Jenkins job to sync packages from the `edb` Cloudsmith repo to the 2ndQuadrant repositories: https://ci.2ndquadrant.com/jenkins/job/pg-backup-api/job/pg-backup-api/build.
You will need to add the pg-backup-api release tag created above to the `SRC_GIT_REF` field and leave `PKG_GIT_REF` at the default value of `main`.
