# pg-backup-api
A server that provides an HTTP API to interact with Postgres backups

## Installation
tbd

## Running the Flask app

### Manually

Install `pg-backup-api` and change to the Barman user, then run

`pg-backup-api serve` 

or `pg-backup-api serve --port N` if you want to use a different port than the default (which is 7480).

### Service

If running from a local source directory, copy `pg-backup-api/packaging/pg-backup-api.service` to `/etc/systemd/system/`. If you've installed
pg-backup-api as a package, installation will put the service file in the right place for you.

Then run
`systemctl enable pg-backup-api`
`systemctl start pg-backup-api`

to run it.

### Verify the app

`pg-backup-api status` returns "OK" if the app is up and running.

## Code Autogeneration

**This only needs to be done if the spec file or mustache templates have been changed.**

### To regenerate code from the spec

This regenerates everything under the `openapi_server` directory. 

The only things that should meaningfully be changed/added to over time would be the controllers and models (which are 
defined by the spec yaml file). The other files are boilerplate helper code for the server. If changes are necessary 
that don't fall into the spec, update the mustache templates under `generator_templates` instead of updating the 
generated code directly. Otherwise, subsequent code generation will clobber those changes.

- Make sure docker is installed on your machine
- Build the docker image running `make build-docker-generate`
- Generate code running `make generate`
  - It will generate code in `pg_backup_api/pg_backup_api/openapi_server/`. It will also generate two empty directories 
  `test` and `openapi`. You can delete or ignore these.
  - File post-processing is handled by `build/post_generation_processing.sh`

### You may also need to...

#### Modify generated code

As mentioned earlier, in general, the code under `openapi_server` should not be directly modified manually... except 
that, unfortunately, there are a couple things that can't (as of writing this, at least) be fixed in the templates, and 
therefore have to be updated manually after code generation. 

- clean up unused imports in generated files to make flake8 happy

Not all controllers will need all the default imports. In the future, it may be worthwhile to try to mess with the 
templates to avoid this manual step, but for now I don't think we know enough about what future controllers/models will 
look like for it not to be wasted effort.


#### Modify backend logic
- Modify or add to files in `pg_backup_api/logic` as needed to implement the updated endpoint logic.
If new routing between the autogenerated controllers and the logic controllers is needed, modify 
`pg_backup_api/logic/adapter.py` to accomodate.

#### Update spec
openapi specs documentation can be find here: https://spec.openapis.org/oas/v3.0.0

## Testing
tbd

## Technology notes and other reference material
For more information on openapi-generator, look at docs
https://github.com/OpenAPITools/openapi-generator
https://openapi-generator.tech/docs/templating

For the process of generating app stub code from an openapi spec, and how Flask and Connexion and everything goes 
together in the process (Note that it uses an older version of OAS and associated tools; here we're using OAS 3.0.0 and 
correspondingly openapi-generator, not swagger-codegen.) https://haseebmajid.dev/blog/rest-api-openapi-flask-connexion
