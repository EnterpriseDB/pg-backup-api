# pg-backup-api
A server that provides an HTTP API to interact with Postgres backups


# To run the Flask app

Install `pg_backup_api` and change to the Barman user, then run

`pg-backup-api serve`


# Code Autogeneration

This only needs to be done if the spec file has been changed.

To generate new server controller/model code from the spec,

- Make sure you have `openapi-generator` and `black` installed on your computer

- Set the env variable `PYTHON_POST_PROCESS_FILE` to where the `black` executable is installed

- From the top-most `pg_backup_api` directory, run
`openapi-generator generate --enable-post-process-file -i pg_backup_api/spec/pg_backup_api.yaml -o pg_backup_api -t ../generator_templates -g python-flask`

It will also generate two empty directories - `test` and `openapi`. You can delete or ignore these.

You may also need to 
    - clean up unused imports in generated files to make flake8 happy

Not all controllers will need all the default imports. In the future, it may be worthwhile to try to mess with the templates to avoid this manual step, but for now I don't think we know enough about what future controllers/models will look like for it not to be wasted effort.

    - prepend `pg_backup_api` to `openapi_server` in autogenerated imports

For example, `from openapi_server.models.diagnose_output import DiagnoseOutput` needs to become `from pg_backup_api.openapi_server.models.diagnose_output import DiagnoseOutput`. Again, in future we may be able to figure out how get the generator to do this for us, but for now it seems like we'd need to fork the generator code itself, as these imports are pre-computed before they get passed to the template.

- Modify or add to files in `pg_backup_api/logic` as needed to implement the updated endpoint logic.
If new routing between the autogenerated controllers and the logic controllers is needed, modify 
`pg_backup_api/logic/adapter.py` to accomodate.


# Technology notes and other reference material
For more information on openapi-generator, look at docs
https://github.com/OpenAPITools/openapi-generator
https://openapi-generator.tech/docs/templating

For the process of generating app stub code from an openapi spec, and how Flask and Connexion and everything goes together in the process (Note that it uses an older version of OAS and associated tools; here we're using OAS 3.0.0 and correspondingly openapi-generator, not swagger-codegen.) https://haseebmajid.dev/blog/rest-api-openapi-flask-connexion